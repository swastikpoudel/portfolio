<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Login</title>
  <style>
    /* Login Page Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
    }
    
    /* Login Box */
    .login-box {
      background: #1e293b;
      padding: 40px;
      border-radius: 10px;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .login-title {
      text-align: center;
      color: #38bdf8;
      margin-bottom: 30px;
      font-size: 24px;
    }
    
    .login-input {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      background: #2d3748;
      border: 1px solid #4a5568;
      color: white;
      border-radius: 5px;
      font-size: 16px;
    }
    
    .login-input:focus {
      outline: none;
      border-color: #38bdf8;
    }
    
    .login-btn {
      width: 100%;
      padding: 14px;
      background: #38bdf8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      transition: background 0.3s;
    }
    
    .login-btn:hover:not(:disabled) {
      background: #0ea5e9;
    }
    
    .login-btn:disabled {
      background: #64748b;
      cursor: not-allowed;
    }
    
    .error-msg {
      color: #f87171;
      text-align: center;
      margin-top: 15px;
      display: none;
      font-size: 14px;
    }
    
    /* Admin Panel Styles */
    .admin-panel {
      display: none;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .logout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    
    .logout-btn:hover {
      background: #b91c1c;
    }
    
    .total-messages {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 20px;
      font-weight: bold;
    }
    
    /* Message Cards */
    .messages-container {
      margin-top: 20px;
    }
    
    .message-card {
      background: #1e293b;
      padding: 25px;
      margin: 20px 0;
      border-radius: 10px;
      border-left: 5px solid #38bdf8;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .message-name {
      font-size: 20px;
      font-weight: bold;
      color: #38bdf8;
    }
    
    .message-phone {
      background: #2d3748;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .message-text {
      background: #2d3748;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      line-height: 1.6;
    }
    
    .message-image {
      text-align: center;
      margin: 20px 0;
    }
    
    .message-image img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      border: 3px solid #4a5568;
    }
    
    .no-image {
      background: #2d3748;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }
    
    .message-time {
      font-size: 12px;
      color: #94a3b8;
      text-align: right;
      margin-top: 10px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
      font-size: 18px;
    }
    
    .error-box {
      background: #dc2626;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .login-box {
        padding: 30px 20px;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .logout-btn {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>

  <!-- ========== LOGIN PAGE ========== -->
  <div class="container">
    <div id="loginPage" class="login-box">
      <h1 class="login-title">üîê Admin Login</h1>
      <input type="text" id="username" class="login-input" placeholder="Username" autocomplete="username">
      <input type="password" id="password" class="login-input" placeholder="Password" autocomplete="current-password">
      <button id="loginBtn" class="login-btn">Login</button>
      <p id="errorMsg" class="error-msg">‚ùå Invalid username or password</p>
    </div>

    <!-- ========== ADMIN PANEL ========== -->
    <div id="adminPage" class="admin-panel">
      <div class="header">
        <h1 class="login-title">üì© Client Messages</h1>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
      
      <div id="messageCount" class="total-messages">Loading...</div>
      
      <div id="messagesContainer" class="messages-container">
        <div class="loading">Loading messages...</div>
      </div>
    </div>
  </div>

  <script>
    // ========== GLOBAL VARIABLES ==========
    let sessionId = localStorage.getItem('adminSessionId');
    const BACKEND_URL = 'https://swastik-v2-backend.onrender.com';
    
    // ========== ON PAGE LOAD ==========
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      
      // Check if already logged in
      if (sessionId) {
        checkSession();
      } else {
        showLoginPage();
      }
    });
    
    // ========== SETUP EVENT LISTENERS ==========
    function setupEventListeners() {
      // Login button click
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      
      // Press Enter in password field
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    }
    
    // ========== LOGIN HANDLER ==========
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorMsg = document.getElementById('errorMsg');
      const loginBtn = document.getElementById('loginBtn');
      
      // Hide previous error
      errorMsg.style.display = 'none';
      
      // Validate inputs
      if (!username || !password) {
        showError('Please enter both username and password');
        return;
      }
      
      // Disable login button
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Login successful
          sessionId = data.sessionId;
          localStorage.setItem('adminSessionId', sessionId);
          showAdminPage();
          loadMessages();
        } else {
          showError(data.error || 'Invalid credentials');
          document.getElementById('password').value = '';
        }
      } catch (error) {
        showError('Connection failed. Please try again.');
      } finally {
        // Re-enable login button
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }
    
    // ========== CHECK SESSION ==========
    async function checkSession() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/client`, {
          headers: {
            'x-admin-session': sessionId
          }
        });
        
        if (response.ok) {
          showAdminPage();
          loadMessages();
        } else {
          // Session expired or invalid
          localStorage.removeItem('adminSessionId');
          sessionId = null;
          showLoginPage();
          showError('Session expired. Please login again.');
        }
      } catch (error) {
        localStorage.removeItem('adminSessionId');
        sessionId = null;
        showLoginPage();
      }
    }
    
    // ========== LOAD MESSAGES ==========
    async function loadMessages() {
      const container = document.getElementById('messagesContainer');
      const countElement = document.getElementById('messageCount');
      
      // Show loading
      container.innerHTML = '<div class="loading">Loading messages...</div>';
      countElement.textContent = 'Loading...';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/client`, {
          headers: {
            'x-admin-session': sessionId
          }
        });
        
        if (response.status === 401) {
          // Session expired
          handleLogout();
          return;
        }
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        const messages = await response.json();
        
        // Update message count
        countElement.textContent = `üìä Total Messages: ${messages.length}`;
        
        if (messages.length === 0) {
          container.innerHTML = '<div class="loading">No messages yet</div>';
          return;
        }
        
        // Display messages
        container.innerHTML = '';
        messages.forEach(message => {
          const card = createMessageCard(message);
          container.appendChild(card);
        });
        
      } catch (error) {
        container.innerHTML = `
          <div class="error-box">
            <h3>‚ùå Error Loading Messages</h3>
            <p>${error.message}</p>
            <button onclick="loadMessages()" style="margin-top: 10px; padding: 8px 16px; background: #fff; color: #dc2626; border: none; border-radius: 4px; cursor: pointer;">
              Try Again
            </button>
          </div>
        `;
      }
    }
    
    // ========== CREATE MESSAGE CARD ==========
    function createMessageCard(message) {
      const card = document.createElement('div');
      card.className = 'message-card';
      
      // Format date (Nepal time)
      const date = new Date(message.createdAt);
      const nepaliTime = date.toLocaleString('en-GB', {
        timeZone: 'Asia/Kathmandu',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      
      // Image HTML
      let imageHtml = '';
      if (message.image) {
        imageHtml = `
          <div class="message-image">
            <img src="${message.image}" 
                 alt="Uploaded Image"
                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'no-image\\'>‚ùå Image failed to load</div>';">
          </div>
        `;
      } else {
        imageHtml = '<div class="no-image">No image attached</div>';
      }
      
      card.innerHTML = `
        <div class="message-header">
          <div class="message-name">${escapeHtml(message.name || 'Anonymous')}</div>
          <div class="message-phone">üì± ${escapeHtml(message.phone || 'No phone')}</div>
        </div>
        
        <div class="message-text">${escapeHtml(message.message || 'No message')}</div>
        
        ${imageHtml}
        
        <div class="message-time">üïí Sent on: ${nepaliTime} (NST)</div>
      `;
      
      return card;
    }
    
    // ========== LOGOUT HANDLER ==========
    async function handleLogout() {
      try {
        // Notify backend
        await fetch(`${BACKEND_URL}/api/admin/logout`, {
          method: 'POST',
          headers: {
            'x-admin-session': sessionId,
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
        // Ignore errors during logout
      }
      
      // Clear local storage
      localStorage.removeItem('adminSessionId');
      sessionId = null;
      
      // Reset form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      
      // Show login page
      showLoginPage();
    }
    
    // ========== SHOW/HIDE PAGES ==========
    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'block';
      document.getElementById('adminPage').style.display = 'none';
      document.getElementById('errorMsg').style.display = 'none';
    }
    
    function showAdminPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('adminPage').style.display = 'block';
    }
    
    // ========== HELPER FUNCTIONS ==========
    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = `‚ùå ${message}`;
      errorMsg.style.display = 'block';
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ========== AUTO-CHECK EVERY 5 MINUTES ==========
    setInterval(() => {
      if (sessionId) {
        checkSession();
      }
    }, 5 * 60 * 1000); // 5 minutes
    
  </script>
</body>
</html>